using System;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.ComponentModel;
using System.Linq;
using System.Runtime.CompilerServices;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Input;
using MaterialDesignThemes.Wpf;
using QuanLyHocSinh.Model.Entities;
using QuanLyHocSinh.Service;
using QuanLyHocSinh.View.Controls.DanhSachLop;
using QuanLyHocSinh.View.Dialogs.MessageBox;
using QuanLyHocSinh.View.RoleControls;

namespace QuanLyHocSinh.ViewModel.TraCuu
{
    public class LopItem : INotifyPropertyChanged
    {
        public string TenLop { get; set; }

        private bool _isSelected;
        public bool IsSelected
        {
            get => _isSelected;
            set { _isSelected = value; OnPropertyChanged(); }
        }

        public event PropertyChangedEventHandler PropertyChanged;
        protected void OnPropertyChanged([CallerMemberName] string propertyName = null)
            => PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(propertyName));
    }

    public class MonHocItem : INotifyPropertyChanged
    {
        public string TenMonHoc { get; set; }

        private bool _isSelected;
        public bool IsSelected
        {
            get => _isSelected;
            set { _isSelected = value; OnPropertyChanged(); }
        }

        public event PropertyChangedEventHandler PropertyChanged;
        protected void OnPropertyChanged([CallerMemberName] string propertyName = null)
            => PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(propertyName));
    }

    public class SuaGiaoVienViewModel : INotifyPropertyChanged
    {
        // Properties
        private string _lopChuNhiem;

        public string LopChuNhiem
        {
            get => _lopChuNhiem;
            set
            {
                if (_lopChuNhiem != value)
                {
                    // üîπ L∆∞u l·ªõp ch·ªß nhi·ªám c≈© ƒë·ªÉ b·ªè tick
                    string lopCu = _lopChuNhiem;

                    _lopChuNhiem = value;
                    OnPropertyChanged();

                    // üîπ B·ªè tick l·ªõp ch·ªß nhi·ªám c≈© n·∫øu c√≥
                    if (!string.IsNullOrEmpty(lopCu))
                    {
                        var itemCu = DanhSachLopItems.FirstOrDefault(l => l.TenLop == lopCu);
                        if (itemCu != null)
                        {
                            itemCu.IsSelected = false;
                        }
                    }

                    // üîπ Tick l·ªõp ch·ªß nhi·ªám m·ªõi
                    if (!string.IsNullOrEmpty(_lopChuNhiem))
                    {
                        var itemMoi = DanhSachLopItems.FirstOrDefault(l => l.TenLop == _lopChuNhiem);
                        if (itemMoi != null)
                        {
                            itemMoi.IsSelected = true;
                        }
                    }
                }
            }
        }

        private Visibility _isGVCNVisible = Visibility.Collapsed;
        public Visibility IsGVCNVisible
        {
            get => _isGVCNVisible;
            set { _isGVCNVisible = value; OnPropertyChanged(); }
        }

        private string _tenChucVu;

        public string TenChucVu
        {
            get => _tenChucVu;
            set
            {
                if (_tenChucVu != value)
                {
                    _tenChucVu = value;
                    OnPropertyChanged();

                    // ‚úÖ C·∫≠p nh·∫≠t hi·ªÉn th·ªã ComboBox l·ªõp ch·ªß nhi·ªám
                    IsGVCNVisible = _tenChucVu == "Gi√°o vi√™n ch·ªß nhi·ªám" ? Visibility.Visible : Visibility.Collapsed;
                }
            }
        }


        private string _hoTen;
        public string HoTen
        {
            get => _hoTen;
            set { _hoTen = value; OnPropertyChanged(); }
        }

        private string _gioiTinh;
        public string GioiTinh
        {
            get => _gioiTinh;
            set { _gioiTinh = value; OnPropertyChanged(); }
        }

        private DateTime _ngaySinh;
        public DateTime NgaySinh
        {
            get => _ngaySinh;
            set { _ngaySinh = value; OnPropertyChanged(); }
        }

        private string _email;
        public string Email
        {
            get => _email;
            set { _email = value; OnPropertyChanged(); }
        }

        private string _diaChi;
        public string DiaChi
        {
            get => _diaChi;
            set { _diaChi = value; OnPropertyChanged(); }
        }
        public string _maGV;
            public string MaGV
        {
            get => _maGV;
            set { _maGV = value; OnPropertyChanged(); }
        }

        public ObservableCollection<string> DanhSachGioiTinh { get; } =
            new ObservableCollection<string> { "Nam", "N·ªØ" };

        public ObservableCollection<string> DanhSachTenChucVu { get; set; } = new();
        public ObservableCollection<LopItem> DanhSachLopItems { get; set; } = new();
        public ObservableCollection<MonHocItem> DanhSachMonItems { get; set; } = new();
        public ObservableCollection<string> DanhSachLop { get; set; } = new();

        public ICommand SaveCommandGV { get; }
        public ICommand CancelCommandGV { get; }

        public event Action<bool> CloseDialog;

        private readonly GiaoVien _giaoVienGoc;

        public SuaGiaoVienViewModel(GiaoVien giaoVien)
        {
            _giaoVienGoc = giaoVien;

            HoTen = giaoVien.HoTen;
            GioiTinh = giaoVien.GioiTinh;
            NgaySinh = giaoVien.NgaySinh;
            Email = giaoVien.Email;
            DiaChi = giaoVien.DiaChi;
            TenChucVu = giaoVien.ChucVu;
            LopChuNhiem = giaoVien.LopChuNhiemID;
            MaGV = giaoVien.MaGV;

            DanhSachTenChucVu = new ObservableCollection<string>(
                UserService.LayDanhSachTenChucVuTheoVaiTro(giaoVien.VaiTroID));

            var tatCaLop = GiaoVienDAL.GetAllLop();
            var lopDuocChon = new List<string>();
            if (!string.IsNullOrEmpty(giaoVien.LopDayID) && giaoVien.LopDayID != "Ch∆∞a ph√¢n c√¥ng")
            {
                lopDuocChon = giaoVien.LopDayID.Split(new[] { ", " }, StringSplitOptions.RemoveEmptyEntries)
                                               .Select(l => l.Trim()).ToList();
            }

            foreach (var lop in tatCaLop)
            {
                DanhSachLop.Add(lop);
                DanhSachLopItems.Add(new LopItem
                {
                    TenLop = lop,
                    IsSelected = lopDuocChon.Contains(lop)
                });
            }

            _ = InitializeMonHocItemsAsync(giaoVien.BoMon);

            SaveCommandGV = new RelayCommand(Save);
            CancelCommandGV = new RelayCommand(Cancel);
        }

        private async Task InitializeMonHocItemsAsync(string currentBoMon)
        {
            try
            {
                var monDaDuocChon = !string.IsNullOrEmpty(currentBoMon) && currentBoMon != "Ch∆∞a ph√¢n c√¥ng"
                    ? currentBoMon.Split(new[] { ", " }, StringSplitOptions.RemoveEmptyEntries).Select(m => m.Trim()).ToList()
                    : new List<string>();

                var monHocDAL = new MonHocDAL();
                var tatCaMonHoc = await monHocDAL.GetAllMonHocAsync();

                DanhSachMonItems.Clear();
                foreach (var mon in tatCaMonHoc)
                {
                    DanhSachMonItems.Add(new MonHocItem
                    {
                        TenMonHoc = mon.TenMonHoc,
                        IsSelected = monDaDuocChon.Contains(mon.TenMonHoc)
                    });
                }
            }
            catch (Exception ex)
            {
                await ShowNotificationAsync("L·ªói", $"‚ùå L·ªói khi kh·ªüi t·∫°o m√¥n h·ªçc: {ex.Message}");
            }
        }
        private async void Save()
        {
            try
            {
                // Ki·ªÉm tra c√°c tr∆∞·ªùng b·∫Øt bu·ªôc
                if (string.IsNullOrWhiteSpace(HoTen) || string.IsNullOrWhiteSpace(GioiTinh) ||
                    string.IsNullOrWhiteSpace(Email) || string.IsNullOrWhiteSpace(DiaChi))
                {
                    await ShowError("C·∫£nh b√°o", "‚ö†Ô∏è Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!");
                    return;
                }

                // Ki·ªÉm tra tu·ªïi
                var tuoi = DateTime.Today.Year - NgaySinh.Year;
                if (NgaySinh > DateTime.Today.AddYears(-tuoi)) tuoi--;

                if (tuoi < 22)
                {
                    var confirmResult = await DialogHost.Show(
                        new ConfirmDialog($"‚ö†Ô∏è Gi√°o vi√™n ch∆∞a ƒë·ªß 22 tu·ªïi. B·∫°n c√≥ mu·ªën ti·∫øp t·ª•c kh√¥ng?"),
                        "RootDialog_Main");

                    if (confirmResult?.ToString() == "False")
                        return;
                }

                // L·∫•y danh s√°ch l·ªõp v√† m√¥n ƒë∆∞·ª£c ch·ªçn
                var lopDuocChon = DanhSachLopItems.Where(l => l.IsSelected).Select(l => l.TenLop).ToList();
                var monDuocChon = DanhSachMonItems.Where(m => m.IsSelected).Select(m => m.TenMonHoc).ToList();

                // Ki·ªÉm tra gi·ªõi h·∫°n l·ªõp v√† m√¥n
                if (lopDuocChon.Count > 3)
                {
                    await ShowError("C·∫£nh b√°o", "‚ö†Ô∏è M·ªói gi√°o vi√™n ch·ªâ ƒë∆∞·ª£c d·∫°y t·ªëi ƒëa 3 l·ªõp!");
                    return;
                }

                if (monDuocChon.Count > 2)
                {
                    await ShowError("C·∫£nh b√°o", "‚ö†Ô∏è M·ªói gi√°o vi√™n ch·ªâ ƒë∆∞·ª£c d·∫°y t·ªëi ƒëa 2 m√¥n h·ªçc!");
                    return;
                }

                // C·∫≠p nh·∫≠t th√¥ng tin chung
                _giaoVienGoc.HoTen = HoTen;
                _giaoVienGoc.GioiTinh = GioiTinh;
                _giaoVienGoc.NgaySinh = NgaySinh;
                _giaoVienGoc.Email = Email;
                _giaoVienGoc.DiaChi = DiaChi;
                _giaoVienGoc.MaGV = MaGV;
                _giaoVienGoc.ChucVu = TenChucVu;

                // G√°n l·ªõp ch·ªß nhi·ªám (n·∫øu l√† GVCN)
                if (TenChucVu == "Gi√°o vi√™n ch·ªß nhi·ªám")
                {
                    if (!string.IsNullOrWhiteSpace(LopChuNhiem))
                    {
                        string? loi;
                        bool thanhCong = GiaoVienDAL.CapNhatLopChuNhiem(_giaoVienGoc.MaGV, LopChuNhiem, out loi);

                        if (!thanhCong)
                        {
                            await ShowError("L·ªói", $"‚ö†Ô∏è {loi}");
                            return;
                        }
                        //// N·∫øu g√°n l·ªõp ch·ªß nhi·ªám m·ªõi th√†nh c√¥ng, m·ªõi x√≥a l·ªõp ch·ªß nhi·ªám c≈© (n·∫øu kh√°c l·ªõp m·ªõi)
                        //if (_giaoVienGoc.LopChuNhiemID != null && _giaoVienGoc.LopChuNhiemID != LopChuNhiem)
                        //{
                        //    GiaoVienDAL.ClearLopChuNhiem(_giaoVienGoc.MaGV);
                        //}

                        _giaoVienGoc.LopChuNhiemID = LopChuNhiem;
                    }
                    else
                    {
                        _giaoVienGoc.LopChuNhiemID = null;
                    }
                }
                else
                {
                    // N·∫øu kh√¥ng ph·∫£i GVCN th√¨ x√≥a th√¥ng tin l·ªõp ch·ªß nhi·ªám
                    GiaoVienDAL.ClearLopChuNhiem(_giaoVienGoc.MaGV);
                    _giaoVienGoc.LopChuNhiemID = null;
                }

                // C·∫≠p nh·∫≠t th√¥ng tin gi√°o vi√™n
                GiaoVienDAL.UpdateGiaoVien(_giaoVienGoc);
                string message;
                // C·∫≠p nh·∫≠t ph√¢n c√¥ng d·∫°y
                bool thanhcong = GiaoVienDAL.UpdatePhanCongDay(_giaoVienGoc.MaGV, lopDuocChon, monDuocChon, out message);
                if (thanhcong)
                {
                    await ShowNotificationAsync("Th√†nh c√¥ng", "‚úÖ C·∫≠p nh·∫≠t th√¥ng tin th√†nh c√¥ng!");
                    CloseDialog?.Invoke(true);
                }
                else
                {
                    await ShowError("L·ªói", $"{message}");
                }

            }
            catch (Exception ex)
            {
                await ShowError("L·ªói", $"‚ùå L·ªói khi l∆∞u: {ex.Message}");
            }
        }




        private void Cancel() => CloseDialog?.Invoke(false);

        public event PropertyChangedEventHandler PropertyChanged;
        protected void OnPropertyChanged([CallerMemberName] string propertyName = null)
            => PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(propertyName));

        private async Task ShowNotificationAsync(string title, string message)
        {
            try
            {
                await DialogHost.Show(new NotifyDialog(title, message), "RootDialog_SuaGV");
            }
            catch
            {
                MessageBox.Show(message, title, MessageBoxButton.OK,
                    title.Contains("L·ªói") ? MessageBoxImage.Error : MessageBoxImage.Information);
            }
        }
        private async Task ShowError(string title, string message)
        {
            try
            {
                await DialogHost.Show(new ErrorDialog(title, message), "RootDialog_SuaGV");
            }
            catch
            {
                MessageBox.Show(message, title, MessageBoxButton.OK,
                    title.Contains("L·ªói") ? MessageBoxImage.Error : MessageBoxImage.Information);
            }
        }
    }
}
